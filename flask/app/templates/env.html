<!-- extend base layout -->
{% extends "base.html" %}


{% block content %}
<div class="container">
    {% include 'flash.html' %}

<div class="col-lg-8">


<p>
<br>
<h4>
This details the demo runtime environment and major services.

</h4>
<p>

<br>

 <img src="/static/img/devops_env.png" height="454" width="800" />


<div class="center-block">
 <h5><u>Environment Highlights</u></h5>

The DevOps vApp is an Ubuntu VM that hosts the following Servers
<ul>
<li> Jenkins  1.609</li>
<li> Chef  12.0.7_1</li>
<li> Artifactory 3.6.0  </li>
<li> Selenium</li>
</ul>

</div>
<br>
The Devops server and the VM's generated by the demo are all accessble <br>
through the public gateway using ssh and http.
<br>
<br>



<h4>Install vca-cli</h4>


<br>
<b>Mac Installation</b>
<pre class="pre-scrollable">

$ sudo pip install virtualenv

$ cd ~
$ virtualenv pythonenv
$ cd pythonenv
$ source bin/activate

$ python -V
  Python 2.7.5

// Get a specific version of vca-cli not the production version.
$ pip install vca-cli==10rc8

// check version, should be same as below
# vca --version
  vca-cli version 10rc8 (pyvcloud: 12rc4)

</pre>

<a href="https://github.com/vmware/vca-cli" target="_blank">(more info)</a>


<h3>Too few public IP's ?</h3>

Having fewer public Ip's than VM's is a typical scenario on vCloud Air.<br>
This section presents a number of solutions for forwarding ssh and http from a single ip <br>

The approach selected will depend on whether the user has admin access to the vCloud Air Gateway appliance.
<br>
<br>
<h4>Routing http with the vCloud Air Gateway </h4>

If the vCloud Air gateway configuration can be modified, <br>
new DNAT rules can be added to route http requests based on their port<br>
to other servers on the private network.<br>
These changes can be performed through the vCloud Air Console or using vca-cli

<pre class="pre-scrollable">

vca nat add --type DNAT  --original-ip 23.92.225.229 --original-port 80 --translated-ip $IP --translated-port 80 --protocol any

</pre>

<h4>Routing ssh with the vCloud Air Gateway</h4>

If the vCloud Air Gateway configuration can be modified then new DNAT rules can be added to route ssh requests <br>
from the gateway to other servers on the internal network.  For example

<pre class="pre-scrollable">

vca nat add --type DNAT  --original-ip 23.92.225.229 --original-port 44 --translated-ip 192.168.109.101 --translated-port 22 --protocol any
</pre>

<br>

<h4><u>Alternative:</u> Routing http with the IPTables </h4>

If the gateway cannot be modifed, then using IPTables on a server on the inside network is an alternative approach.<br>
The devops server hosting this demo using this method.<br> 

All browser requests from the internet are made to devops.vcair.us which is configured with a single NAT rule to forward all requests
to the devops server.  The IPTables firewall on the devops server is configured to forward requests for certain ports
to other servers / port combinations on the internal network.<br>
<br>
IPTable commands can be issued dynamically in a shell using Jenkins when the artifact is deployed.

<br>
For example, This command will route a request to devops.vcair.us:8080 to a server on the internal network at 192.168.109.7:8080 <br>

<pre class="pre-scrollable">
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 8080 -m conntrack --ctstate NEW -j DNAT --to 192.168.109.7:8080
</pre>
<br>


<h4> <u>Alternative:</u> Using an ssh gateway to route ssh</h4>
  
If configuration of the vCloud Air Gateway is not possible, then a ssh proxy can be configured.<br>

The sshd server on the devops Server acts as a ssh gateway so that remote clients can connect to the VMs.
This is possible since the same ubuntu user and its key are used to connect to the devops server and other servers in the demo.
The devops server has the ubuntu public key in ~ubuntu/.ssh/authorized_keys 
The devops server acts as a ssh proxy.

In the client .ssh/config file
<br>

<pre class="pre-scrollable">
Host devops
  Hostname 23.92.225.171
# next 2 lines for connecting to jenkins directly
# enables this command form -> ssh ubuntu@devops
  User ubuntu
  IdentityFile ~/.ssh/ubuntu_rsa

# For any host on private network behind vca gateway 23.92.225.171->192.168.109.3
# Proxied by ssh on 192.168.109.3 
# enables this command form -> ssh ubuntu@192.168.109.4
Host 192.168.109.*
  User ubuntu
  IdentityFile ~/.ssh/ubuntu_rsa
  ProxyCommand ssh -q jenkins -l ubuntu  -i ~/.ssh/ubuntu_rsa  nc -q0 %h %p

</pre>

Then for example, the following command will connect to 192.168.109.4, through the devops server behind 23.92.225.171
<br>

ssh 192.168.109.4
<br>


</pre>

<br>
<h4>Define Aliases for SSH on local workstation</h4>
<br>

The complexity of different ssh ports can be hidden by configuring ssh aliases on the developer workstation.<br>

Create a  ~/.ssh/.client file of your <br>
 home directory to simplify port mappings. <br>
For example<br>
<br>

<pre class="pre-scrollable">
alpha   23.92.225.229 22
bravo   23.92.225.229 33
charlie 23.92.225.229 44
</pre>

This allows conections using commands such as

<pre class="pre-scrollable">
ssh ubuntu@alpha
</pre>

<br>
</div>
{% endblock %}

