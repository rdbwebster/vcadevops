<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <link href="/static/css/custom.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:600italic,600|PT+Sans+Narrow|Oswald|PT+Sans' rel='stylesheet' type='text/css'>
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>

    <script> 
      $(function(){
         $("#header").load("base.html"); 
      });
    </script> 

</head>

<body>

<div id="header"></div>


<div class="container">
  <h2>Photon Server Scenario</h2>


<div class="col-lg-8">


<p>
<br>
<h4>
This scenario shows how to use the vCloud Air CLI to create a VM running Photon and start the Docker Service.
</h4>

<br>
<br>
<span class="learn-more"> Learn more about the vCloud Air CLI </span>  <br>
<a href="https://github.com/vmware/vca-cli" target="_blank">https://github.com/vmware/vca-cli</a>
<br>
<br>
<span class="learn-more"> Learn more about Photon </span>  <br>
<a href="https://github.com/vmware/photon" target="_blank">https://github.com/vmware/photon</a>
<br>
<br>
<br>
<h3>Prerequisites</h3>
<ul>
<li>To run vca-cli, the vca command line interface must be installed on the workstation.</li>
<li>For OnDemand Service Accounts: A Photon image is available in the vCloud Air public catalog  </li>
<li>For Subsription Service Accounts: A Photon .iso must be uploaded to a VM and stored in a VDC custom catalog  </li>
<li>The Edge Gateway should be configured to support DNS forwarding.</li>
<li>Note that the new VM created in this example is accessed from outside vcloud Air through an existing ssh proxy running in the VDC.  
This approach removes the need for a new public ip on the gateway for every new VM..
Refer to the 'Setting up ssh for vCloud Air' section in under the Docs link for details on how to configure a proxy node.
</li>
</ul>
<br>
<br>
 <img src="./static/img/vca_cli.png"/>

<br>


<div class="center-block">
 The vca cli will... 
<br>
<br>
 <ol type="1">

<li> Connect to vCloud Air </li>
<li> Create the VM using the vCloud Air API </li>
<li> Start the VM  </li>
<li> SSH into Photon and start the Docker Service  </li>
</ol>

</div>

<br>
<h3>Commands</h3>

Here are the vca-cli commands necessary to run the scenario.<br>
.
If executed from within vCloud Air (for example from Jenkins) then the public IP and NAT configuration steps can be omitted.
<br>
<br>
Click on
<a href="http://devops.vcair.us:8100/job/create_photon/" target="_blank"><button type="button">Run the Demo<span class="glyphicon glyphicon-play"></button></a>
<i>to try it. (Login required)</i>
</p>




<pre class="pre-scrollable">
# Login
vca login appstech@websterx.com --password "$VCA_PASS" --instance 97453e02-e83c-4cae-bbe9-3f7ee6dd8401 --vdc VDC1

export VAPP_NAME=vcaPhoton
export VM_NAME=vcaPhoton

# Create a vApp
vca vapp create -a $VAPP_NAME -V photonNode -c 'Public Catalog' -t 'VMware Photon OS - Tech Preview 2' -n default-routed-network  -m pool

# power on the vApp
vca vapp power-on --vapp $VAPP_NAME 

sleep 5

# Get the IP of the new node

export IP=`vca vm -a $VAPP_NAME | grep $VM_NAME | cut -d '|' -f5 |  tr -d '[[:space:]]'`
  
# Get the initial admin password for root
export ADMIN_PASS=$(vca vapp info --vapp $VAPP_NAME | grep admin_password | cut -d\| -f4)

# ssh into Photon and enable and start Docker
sshpass -p $ADMIN_PASS -e ssh -t -v root@${IP} "systemctl enable docker && systemctl start docker && systemctl status docker"


</pre>
</div>
</div>

</body>
</html>
